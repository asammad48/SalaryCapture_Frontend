trigger:
  branches:
    include:
      - none
parameters:
  - name: buildConfiguration
    displayName: Select Build Configuration
    type: string
    default: test
    values:
      - test
variables:
  acrLoginServer: crsalarycalculationtest001.azurecr.io
  acrName: crsalarycalculationtest001
  imageName: salarycapturefe
  imageTag: $(Build.BuildId)
  containerAppName: ca-salarycapturefe-test
  resourceGroup: rg-container-test-001
  location: westeurope
  dockerfilePath: 'DockerFile'
  azureSubscription: 'sc-rg-container-test-001'
  dockerContext: '.'
  BUILD_CONFIGURATION: ${{ parameters.buildConfiguration }}

stages:
- stage: BuildAndPush
  displayName: Build and Push Docker Image to ACR
  jobs:
  - job: BuildPushImage
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self

    - task: AzureCLI@2
      name: BuildPush
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "Logging into ACR..."
          az acr login --name $(acrName)

          echo "Building Docker image with tags: $(imageTag) and latest..."
          docker build -f $(dockerfilePath) \
            -t $(acrLoginServer)/$(imageName):$(imageTag) \
            -t $(acrLoginServer)/$(imageName):latest \
            --build-arg BUILD_CONFIGURATION=$(BUILD_CONFIGURATION)  \
            $(dockerContext)

          echo "Pushing Docker image with tag: $(imageTag)..."
          docker push $(acrLoginServer)/$(imageName):$(imageTag)

          echo "Pushing Docker image with tag: latest..."
          docker push $(acrLoginServer)/$(imageName):latest

- stage: DeployToContainerApp
  displayName: Deploy Image to Azure Container App
  dependsOn: BuildAndPush
  jobs:
  - job: Deploy
    displayName: Deploy to ACA
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: AzureCLI@2
      name: DeployContainerApp
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "Updating ACA image..."
          az containerapp update \
            --name $(containerAppName) \
            --resource-group $(resourceGroup) \
            --image $(acrLoginServer)/$(imageName):latest
          echo "Deployment complete."
    - task: AzureCLI@2
      displayName: "Restart Azure Container App"
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az containerapp restart \
            --name $(containerAppName) \
            --resource-group $(resourceGroup)
          echo "Container App restarted."