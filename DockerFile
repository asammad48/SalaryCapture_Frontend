# --------------------------
# Stage 1: Build Angular/Nx app
# --------------------------
FROM node:18 AS build
WORKDIR /app

# Accept build configuration from pipeline (qa, test, production, etc.)
ARG BUILD_CONFIGURATION=production
ENV BUILD_CONFIGURATION=${BUILD_CONFIGURATION}

RUN echo "========================================="
RUN echo "Stage 1: Building Angular application"
RUN echo "Build configuration: ${BUILD_CONFIGURATION}"
RUN echo "========================================="

# Copy dependencies and install
COPY package*.json ./
RUN echo "Installing npm dependencies..."
RUN npm ci
RUN echo "npm dependencies installed successfully"

# Copy source code
COPY . .
RUN echo "Source code copied to container"

# Print current configuration and run the corresponding build script
RUN echo "Starting Angular build with configuration: ${BUILD_CONFIGURATION}" && \
    if npm run | grep -q "build-${BUILD_CONFIGURATION}"; then \
        echo "Running npm run build-${BUILD_CONFIGURATION}"; \
        npm run build-${BUILD_CONFIGURATION}; \
    else \
        echo "build-${BUILD_CONFIGURATION} script not found, defaulting to npm run build"; \
        npm run build; \
    fi

RUN echo "Angular build completed"
RUN echo "Listing build output:"
RUN ls -la /app/dist/daily-planning

# --------------------------
# Stage 2: Serve with Nginx
# --------------------------
FROM nginx:alpine

RUN echo "========================================="
RUN echo "Stage 2: Setting up Nginx server"
RUN echo "========================================="

# Copy compiled Angular app from the build stage
COPY --from=build /app/dist/daily-planning /usr/share/nginx/html
RUN echo "Copied Angular build files to /usr/share/nginx/html"
RUN echo "Listing copied files:"
RUN ls -la /usr/share/nginx/html

# Copy your custom Nginx configuration
COPY nginx.conf /etc/nginx/conf.d/default.conf
RUN echo "Copied nginx.conf to /etc/nginx/conf.d/default.conf"

RUN echo "========================================="
RUN echo "Docker build completed successfully!"
RUN echo "Application will be served on port 80"
RUN echo "========================================="

# Optional: Health check for Azure Container Apps
HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
  CMD wget -qO- http://localhost:80/ || exit 1

EXPOSE 80
