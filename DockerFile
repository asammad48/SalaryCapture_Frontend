# --------------------------
# Stage 1: Build Angular/Nx app
# --------------------------
FROM node:20-alpine AS build
WORKDIR /app

# Accept build configuration from pipeline (development, test, qa, production)
ARG BUILD_CONFIGURATION=development
ENV BUILD_CONFIGURATION=${BUILD_CONFIGURATION}

RUN echo "========================================="
RUN echo "Stage 1: Building Angular application"
RUN echo "Build configuration: ${BUILD_CONFIGURATION}"
RUN echo "========================================="

# Copy dependencies and install
COPY package*.json ./
RUN echo "Installing npm dependencies..."
RUN npm ci
RUN echo "npm dependencies installed successfully"

# Copy source code
COPY . .
RUN echo "Source code copied to container"

# Build based on configuration
# Available scripts: build (production), build-test, build-qa
RUN echo "Starting Angular build with configuration: ${BUILD_CONFIGURATION}" && \
    case ${BUILD_CONFIGURATION} in \
        "production") \
            echo "Running production build..."; \
            npm run build;; \
        "test") \
            echo "Running test build..."; \
            npm run build-test;; \
        "qa") \
            echo "Running QA build..."; \
            npm run build-qa;; \
        "development") \
            echo "Running development build (using test config)..."; \
            npm run build-test;; \
        *) \
            echo "Unknown configuration: ${BUILD_CONFIGURATION}, defaulting to production build"; \
            npm run build;; \
    esac

RUN echo "Angular build completed"
RUN echo "Listing build output:"
RUN ls -la /app/dist/daily-planning/browser || ls -la /app/dist/daily-planning

# --------------------------
# Stage 2: Serve with Nginx
# --------------------------
FROM nginx:alpine

RUN echo "========================================="
RUN echo "Stage 2: Setting up Nginx server"
RUN echo "========================================="

# Copy compiled Angular app from the build stage
# Angular 17+ outputs to browser subdirectory
COPY --from=build /app/dist/daily-planning/browser /usr/share/nginx/html
RUN echo "Copied Angular build files to /usr/share/nginx/html"
RUN echo "Listing copied files:"
RUN ls -la /usr/share/nginx/html

# Copy custom Nginx configuration
COPY nginx.conf /etc/nginx/conf.d/default.conf
RUN echo "Copied nginx.conf to /etc/nginx/conf.d/default.conf"

RUN echo "========================================="
RUN echo "Docker build completed successfully!"
RUN echo "Application will be served on port 8080"
RUN echo "========================================="

# Health check for container orchestration
HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
  CMD wget -qO- http://localhost:8080/ || exit 1

EXPOSE 8080
