# --------------------------
# Stage 1: Build Angular/Nx app
# --------------------------
FROM node:18 AS build
WORKDIR /app

# Accept build configuration from pipeline (qa, test, production, etc.)
ARG BUILD_CONFIGURATION=production
ENV BUILD_CONFIGURATION=${BUILD_CONFIGURATION}

# Copy dependencies and install
COPY package*.json ./
RUN npm ci

# Copy source code
COPY . .

# Print current configuration and run the corresponding build script
RUN echo "üèóÔ∏è  Building Angular app using configuration: ${BUILD_CONFIGURATION}" && \
    if npm run | grep -q "build-${BUILD_CONFIGURATION}"; then \
        echo "‚û°Ô∏è  Running npm run build-${BUILD_CONFIGURATION}"; \
        npm run build-${BUILD_CONFIGURATION}; \
    else \
        echo "‚ö†Ô∏è  build-${BUILD_CONFIGURATION} script not found, defaulting to npm run build"; \
        npm run build; \
    fi

# --------------------------
# Stage 2: Serve with Nginx
# --------------------------
FROM nginx:alpine

# Copy compiled Angular app from the build stage
COPY --from=build /app/dist/* /usr/share/nginx/html

# Copy your custom Nginx configuration
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Optional: Health check for Azure Container Apps
HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
  CMD wget -qO- http://localhost:80/ || exit 1

EXPOSE 80
