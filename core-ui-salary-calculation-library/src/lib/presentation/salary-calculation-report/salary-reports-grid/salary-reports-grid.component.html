<nav aria-label="breadcrumb" class="d-flex align-items-center justify-content-between mt-3 height-2" [ngClass]="isFilterApplied?'mb-2':'mb-3'">
    <p-breadcrumb class="max-w-full fw-medium" [model]="items" [home]="home"></p-breadcrumb>
</nav>

<div class="d-flex align-items-center gap-2 mb-2" *ngIf="isFilterApplied">
  <label class="fs-14 fw-semibold color-gray-800">Applied Filters:</label>

  <!-- Loop over appliedFilters array -->
  <ng-container *ngFor="let filter of appliedFilters">
    <div
      class="badge py-px-6 color-gray-800 bg-gray-100 d-inline-flex align-items-center justify-content-between gap-10 fs-12">
      <div class="fw-normal lh-1-3 d-flex gap-1" [title]="filter.label">
        <span class="text-capitalize">{{ filter.label }}:</span>
        <span class="d-inline-block max-w-5 text-truncate" [title]="filter.value">
          {{ filter.value }}
        </span>
      </div>
      <span class="close" (click)="removeFilter(filter.key)" id="remove-{{filter.label}}-filter-btn">
        <i class="fa-regular fa-circle-xmark fs-13 hover-gray-600 color-gray-700"></i>
      </span>
    </div>
  </ng-container>
</div>



<div class="card d-flex flex-column shadow-md h-64 border-0">
  <salary-calculation-portal-progress-loading loaderKey="SalaryReport_ReportHistory"></salary-calculation-portal-progress-loading>

      <p-table
        #dt
        id="salaryCalculationReportsTable"
        [value]="exportedSalaryReports$"
        appendTo="body"
        [paginator]="true"
        [rows]="rows"
        [first]="first"
        [totalRecords]="totalRecords"
        showGridlines [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        [rowsPerPageOptions]="rowsPerPageOptions"
        [styleClass]="isFilterApplied ? 'thead-sticky datawrapper-vh-220':'thead-sticky datawrapper-vh-190'"
        tableStyleClass="table table-p-3 salary-history-table"
        [scrollable]="true"
        (onPage)="onPageChange($event)">

        <ng-template pTemplate="header">
            <tr>
                <th class="position-relative min-w-8">Region
                    <p-popover #regionFilter styleClass="popover-content-p-0 popover-arrow-none mt-0 min-w-16" id="region-filter-popover">
                        <div class="p-10">
                            <div class="input-group-wrapper end">
                                <input type="text" class="form-control focus-none border-gray-400" id="region-filter-input"
                                    placeholder="Search..." [(ngModel)]="regionFilterValue" (keyup.enter)="applyFilters()">
                                <div class="input-group-media icon">
                                    <svg aria-label="dropdown">
                                        <use xlink:href="#search"></use>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-center justify-content-end p-10">
                            <div class="btn-group">
                                <button class="btn btn-link btn-sm fw-normal py-1" (click)="resetFilter()" id="region-filter-reset-btn">Reset
                                </button>
                                <button class="btn btn-primary btn-sm fw-normal py-1 rounded-5"
                                    (click)="applyFilters()" id="region-filter-apply-btn">Apply
                                </button>
                            </div>
                        </div>
                    </p-popover>
                    <div (click)="regionFilter.toggle($event)"
                        class="color-gray-600 d-inline-block position-absolute top-2 end-4 p-1" id="region-filter-toggle-btn">
                        <i class="fa-filter fa-solid fs-12"></i>
                    </div>
                </th>
                <th class="position-relative min-w-8">Area
                    <p-popover #areaFilter styleClass="popover-content-p-0 popover-arrow-none mt-0 min-w-16" id="area-filter-popover">
                        <div class="p-10">
                            <div class="input-group-wrapper end">
                                <input type="text" class="form-control focus-none border-gray-400" id="area-filter-input"
                                    placeholder="Search..." [(ngModel)]="areaFilterValue" (keyup.enter)="applyFilters()">
                                <div class="input-group-media icon">
                                    <svg aria-label="dropdown">
                                        <use xlink:href="#search"></use>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-center justify-content-end p-10">
                            <div class="btn-group">
                                <button class="btn btn-link btn-sm fw-normal py-1" (click)="resetFilter()" id="area-filter-reset-btn">Reset
                                </button>
                                <button class="btn btn-primary btn-sm fw-normal py-1 rounded-5"
                                    (click)="applyFilters()" id="area-filter-apply-btn">Apply
                                </button>
                            </div>
                        </div>
                    </p-popover>
                    <div (click)="areaFilter.toggle($event)"
                        class="color-gray-600 d-inline-block position-absolute top-2 end-4 p-1" id="area-filter-toggle-btn">
                        <i class="fa-filter fa-solid fs-12"></i>
                    </div>
                </th>
                <th class="min-w-8">From</th>
                <th class="min-w-8">To</th>
                <th class="position-relative min-w-8">Export Status
                    <p-popover #statusFilter styleClass="popover-content-p-0 popover-arrow-none mt-0 min-w-14" id="status-filter-popover">
                        <div class="p-10" [formGroup]="statusFilterForm">
                            <ul class="list-unstyled mb-0 max-h-10 min-h-6 overflow-y-auto">

                                <!-- All checkbox -->
                                <li class="py-2">
                                    <div class="d-flex align-items-center gap-6">
                                        <p-checkbox [binary]="true" inputId="optAll" class="d-flex"
                                            formControlName="all"
                                            [indeterminate]="allStatusIndeterminate"
                                            (keyup.enter)="applyFilters()"
                                            labelStyleClass="fs-14" id="status-filter-all-checkbox">
                                        </p-checkbox>
                                        <label for="optAll" class="fs-14">All</label>
                                    </div>
                                </li>

                                @for (opt of statusOptions; track opt.key) {
                                <li class="py-2">
                                    <div class="d-flex align-items-center gap-6">
                                        <p-checkbox [binary]="true" class="d-flex"
                                            [inputId]="opt.key"
                                            (keyup.enter)="applyFilters()"
                                            [formControlName]="opt.key"
                                            labelStyleClass="fs-14" id="status-filter-{{opt.label}}-checkbox">
                                        </p-checkbox>
                                        <label [for]="opt.key" class="fs-14">{{ opt.label }}</label>
                                    </div>
                                </li>
                                }
                            </ul>
                        </div>

                        <div class="d-flex align-items-center justify-content-end p-10">
                            <div class="btn-group">
                                <button class="btn btn-link btn-sm fw-normal py-1" (click)="resetFilter()" id="status-filter-reset-btn">Reset
                                </button>
                                <button class="btn btn-primary btn-sm fw-normal py-1 rounded-5"
                                    (click)="applyFilters()" id="status-filter-apply-btn">Apply
                                </button>
                            </div>
                        </div>
                    </p-popover>
                    <div (click)="statusFilter.toggle($event)"
                        class="color-gray-600 d-inline-block position-absolute top-2 end-4 p-1" id="status-filter-toggle-btn">
                        <i class="fa-filter fa-solid fs-12"></i>
                    </div>
                </th>
                <th class="position-relative">Generated At
                    <p-popover #dateFilter [dismissable]="isDismissable" styleClass="popover-content-p-0 popover-arrow-none mt-0 min-w-16" id="date-filter-popover">
                        <div class="p-10">
                            <div class="input-group-wrapper end">
                                <p-datepicker styleClass="w-100"
                                    (keyup.enter)="applyFilters()"
                                    inputStyleClass="shadow-none border-gray-400 pe-auto cursor-pointer bg-white w-100"
                                    [(ngModel)]="dateFilterValue" [iconDisplay]="'input'" [showIcon]="true"
                                    inputId="icondisplay" placeholder="dd-mm-yyyy" dateFormat="dd-mm-yy" (onShow)="isDismissable=false"
                                    (onClose)="isDismissable=true" id="date-filter-input" />
                            </div>
                        </div>

                        <div class="d-flex align-items-center justify-content-end p-10">
                            <div class="btn-group">
                                <button class="btn btn-link btn-sm fw-normal py-1" (click)="resetFilter()" id="date-filter-reset-btn">Reset
                                </button>
                                <button class="btn btn-primary btn-sm fw-normal py-1 rounded-5"
                                    (click)="applyFilters()" id="date-filter-apply-btn">Apply
                                </button>
                            </div>
                        </div>
                    </p-popover>
                    <div (click)="dateFilter.toggle($event)"
                        class="color-gray-600 d-inline-block position-absolute top-2 end-4 p-1" id="date-filter-toggle-btn">
                        <i class="fa-filter fa-solid fs-12"></i>
                    </div>
                </th>
                <th>Generated By</th>
                <th class="min-w-5">Action</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-report>
            <tr>
                <td>{{ report.region || '-' }}</td>
                <td>{{ report.areaName || '-' }}</td>
                <td>{{ formatDate(report.fromDate) || '-' }}</td>
                <td>{{ formatDate(report.toDate) || '-' }}</td>
                <td>
                    <span *ngIf="report.exportStatus === ExportStatus.Pending" class="text-secondary">Pending</span>
                    <span *ngIf="report.exportStatus === ExportStatus.Problem"
                        class="text-danger">Problem</span>
                    <span *ngIf="report.exportStatus === ExportStatus.Success" class="text-success">Success</span>
                    <span *ngIf="report.errorCode" class="ms-2 color-danger-700 fs-13">{{ report.errorMessage }}</span>
                </td>
                <td class="min-w-px-200">{{ formatDateTime(report.generatedAt) || '-' }}</td>

                <td class="min-w-px-200">{{ report.generatedByName || '' }}
                    <div class="color-gray-600">{{ report.generatedByUserName || ''}}</div>
                </td>

                <td>
                  <!-- Pending -->
                  <!-- @if (report.exportStatus === ExportStatus.Pending) {
                    <div class="cursor-default">
                      <a
                        id="downloadReportBtn"
                        class="color-primary disabled"
                        aria-disabled="true"
                        disabled
                      >
                        <i class="pi pi-cog pi-spin pi-sm me-1"></i>
                        In Progress
                      </a>
                    </div>
                  } -->

                  <!-- Problem -->
                  <!-- @if (report.exportStatus === ExportStatus.Problem) {
                    <div class="cursor-pointer">
                      <a
                        (click)="downloadReport(report.id)"
                        id="reExportReportBtn"
                        class="color-primary"
                      >
                        <i class="pi pi-upload me-1"></i>
                        Export
                      </a>
                    </div>
                  } -->

                  <!-- Success -->
                  <!-- @if (report.exportStatus === ExportStatus.Success) { -->
                    <div class="cursor-pointer">
                      <a
                        (click)="downloadReport(report.id)"
                        id="download-report-{{report.id}}-btn"
                        class="color-primary"
                      >
                        <i class="pi pi-download me-1"></i>
                        Download
                      </a>
                    </div>
                  <!-- } -->
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <div class="empty-state grid">
                <div class="illustration bg-white">
                    <svg class="height-12 width-12">
                        <use xlink:href="#empty-state"></use>
                    </svg>
                </div>
                <p class="bg-white fs-18 p-0 fw-medium color-gray-700">No Record Found</p>
            </div>
        </ng-template>
    </p-table>
</div>
