<div class="d-flex align-items-center gap-2 mb-2 ps-1" *ngIf="isGroupFilterApplied">
  <label class="fs-14 fw-semibold color-gray-800">Applied Filters:</label>

  <!-- Loop over appliedFilters array -->
  <ng-container *ngFor="let filter of groupAppliedFilters">
    <div
      class="badge py-px-6 color-gray-800 bg-gray-100 d-inline-flex align-items-center justify-content-between gap-10 fs-12">
      <div class="fw-normal lh-1-3 d-flex gap-1" [title]="filter.label">
        <span class="text-capitalize">{{ filter.label }}:</span>
        <span class="d-inline-block max-w-5 text-truncate" [title]="filter.value">
          {{ filter.value }}
        </span>
      </div>
      <span class="close" (click)="removeGroupFilters(filter.key)" id="remove-{{filter.label}}-group-filter-btn">
        <i class="fa-regular fa-circle-xmark fs-13 hover-gray-600 color-gray-700"></i>
      </span>
    </div>
  </ng-container>
</div>

<div class="position-relative">
  <salary-calculation-portal-progress-loading loaderKey="DailyJobs_GetWorkerDailyJobsReport"></salary-calculation-portal-progress-loading>

  @if (!isLoadingWorkerJobsReport && workerJobsReports.length > 0) {
    <div class="vh-197 overflow-auto">

      <!-- Daily Jobs Groups Table -->
      <p-table
        #groupDailyJobsReportTable
        [value]="workerJobsReports"
        stripedRows
        [lazy]="true"
        appendTo="body"
        dataKey="productionDate"
        rowExpandMode="single"
        [scrollable]="true"
        [expandedRowKeys]="expandedRows"
        (onRowExpand)="onRowExpand($event)"
        (onRowCollapse)="onRowCollapse($event)"
        tableStyleClass="table jobs-table"
      >
        <!-- Table Header -->
        <ng-template pTemplate="header">
          <tr>
            <th class="width-px-40 max-w-px-40 start-px-0"></th>
            <th class="text-nowrap max-w-px-240 width-px-240 position-relative">Date
                <p-popover #groupDateFilter [dismissable]="isGroupDismissable" styleClass="popover-content-p-0 popover-arrow-none mt-0 min-w-16" id="group-date-filter-popover">
                  <div class="p-10">
                      <div class="input-group-wrapper end">
                          <p-datepicker styleClass="w-100"
                              (keyup.enter)="applyGroupFilters()"
                              [(ngModel)]="groupDateFilterValue"
                              dateFormat="dd/mm/yy"
                              [showIcon]="true"
                              iconDisplay="input"
                              inputId="group-date-filter-input"
                              placeholder="Select date" />
                      </div>
                  </div>

                  <div class="d-flex align-items-center justify-content-end p-10">
                      <div class="btn-group">
                          <button class="btn btn-link btn-sm fw-normal py-1" (click)="resetGroupFilters()" id="group-date-filter-reset-btn">Reset
                          </button>
                          <button class="btn btn-primary btn-sm fw-normal py-1 rounded-5"
                              (click)="applyGroupFilters()" id="group-date-filter-apply-btn">Apply
                          </button>
                      </div>
                  </div>
              </p-popover>
              <div (click)="groupDateFilter.toggle($event)"
                  class="color-gray-600 d-inline-block position-absolute top-2 end-4 p-1" id="group-date-filter-toggle-btn">
                  <i class="fa-filter fa-solid fs-12"></i>
              </div>
            </th>
            <th class="text-nowrap">
              <span 
                tooltipPosition="top" 
                class="cursor-pointer"
                tooltipStyleClass="p-tooltip-fs-11 cutomized-tooltip"
                pTooltip="Total number of jobs assigned">
                Total Jobs
              </span>
            </th>

            <th class="text-nowrap">
              <span 
                tooltipPosition="top" 
                class="cursor-pointer"
                tooltipStyleClass="p-tooltip-fs-11 cutomized-tooltip"
                pTooltip="Total number of jobs against which job completed event is received">
                Completed Jobs
              </span>
            </th>

            <th class="text-nowrap">
              <span 
                tooltipPosition="top" 
                class="cursor-pointer"
                tooltipStyleClass="p-tooltip-fs-11 cutomized-tooltip"
                pTooltip="Total number of jobs against which job completed event is not received">
                Pending Jobs
              </span>
            </th>

            <th class="text-nowrap">
              <span 
                tooltipPosition="top" 
                class="cursor-pointer"
                tooltipStyleClass="p-tooltip-fs-11 cutomized-tooltip"
                pTooltip="Total number of manual salary lines">
                Total Salary Lines
              </span>
            </th>

            <th class="text-nowrap">
              <span 
                tooltipPosition="top" 
                class="cursor-pointer"
                tooltipStyleClass="p-tooltip-fs-11 cutomized-tooltip"
                pTooltip="Total number of manual salary lines against which salary transactions are created">
                Processed Salary Lines
              </span>
            </th>

            <th class="text-nowrap">
              <span 
                tooltipPosition="top" 
                class="cursor-pointer"
                tooltipStyleClass="p-tooltip-fs-11 cutomized-tooltip"
                pTooltip="Total number of manual salary lines linked to a job and job completed event not received">
                Pending Salary Lines
              </span>
            </th>
          </tr>
        </ng-template>

        <!-- Table Body - Daily Job Groups by Date -->
        <ng-template pTemplate="body" let-reportGroup let-expanded="expanded" let-i="rowIndex">
          <tr>
            <td class="position-sticky start-px-0 px-8 max-w-px-40 width-px-40">
              <button
                type="button"
                id="table-row-toggle-btn{{ i }}"
                pButton
                [pRowToggler]="reportGroup"
                class="p-button-text bg-transparent w-100 rounded-circle p-0 height-px-24"
                [icon]="expanded ? 'pi pi-chevron-down fs-14 color-gray-700' : 'pi pi-chevron-right fs-14 color-gray-700'"
              ></button>
            </td>
            <td class="position-sticky px-8">
              {{ reportGroup.productionDate || '' }}
            </td>
            <td class="position-sticky px-8">
              {{ reportGroup.totalJobs || 0 }}
            </td>
            <td class="position-sticky px-8">
              {{ reportGroup.completedJobs || 0 }}
            </td>
            <td class="position-sticky px-8">
              {{ reportGroup.pendingJobs || 0 }}
            </td>
            <td class="position-sticky px-8">
              {{ reportGroup.totalSalaryLines || 0 }}
            </td>
            <td class="position-sticky px-8">
              {{ reportGroup.processedSalaryLines || 0 }}
            </td>
            <td class="position-sticky px-8">
              {{ reportGroup.pendingSalaryLines || 0 }}
            </td>
          </tr>
        </ng-template>

        <!-- Empty State -->
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8">
              <div class="min-h-20">
                <div class="empty-state grid bg-white py-5">
                  <div class="illustration bg-white">
                    <svg class="height-12 width-12">
                      <use xlink:href="#empty-state"></use>
                    </svg>
                  </div>
                  <p class="bg-white fs-18 p-0 fw-medium color-gray-700">No Records Found.</p>
                </div>
              </div>
            </td>
          </tr>
        </ng-template>

        <!-- Expanded Row - Daily Jobs Table -->
        <ng-template #expandedrow pTemplate="rowexpansion" let-reportGroup>

          <tr>

            <td colspan="8" class="p-0 bg-gray-300">

              <p-table
                [value]="reportGroup.areas"
                dataKey="organizationUnitName"
                [scrollable]="true"
                tableStyleClass="table manual-line-table"
                styleClass="p-datatable-gridlines p-datatable-md p-datatable-white nested-grid-overflow-unset"
              >

                <!-- Daily Jobs Header -->
                <ng-template pTemplate="header">
                  <tr>
                    <th class="start-px-0 px-8 width-px-40 max-w-px-40"></th>
                    <th class="text-nowrap max-w-px-240 width-px-240">Area</th>
                    <th class="text-nowrap">Total Jobs</th>
                    <th class="text-nowrap">Completed Jobs</th>
                    <th class="text-nowrap">Pending Jobs</th>
                    <th class="text-nowrap">Total Salary Lines</th>
                    <th class="text-nowrap">Processed Salary Lines</th>
                    <th class="text-nowrap">Pending Salary Lines</th>
                  </tr>
                </ng-template>

                <!-- Daily Jobs Body -->
                <ng-template pTemplate="body" let-area let-i="rowIndex">
                  <tr>
                    <td class="start-px-0 px-8 width-px-40 max-w-px-40"></td>
                    <td class="position-sticky px-8 py-px-12">
                      {{ area.organizationUnitName || '-' }}
                    </td>
                    <td class="position-sticky px-8 py-px-12">
                      {{ area.totalJobs || 0 }}
                    </td>
                    <td class="position-sticky px-8 py-px-12">
                      {{ area.completedJobs || 0 }}
                    </td>
                    <td class="position-sticky px-8 py-px-12">
                      {{ area.pendingJobs || 0 }}
                    </td>
                    <td class="position-sticky px-8 py-px-12">
                      {{ area.totalSalaryLines || 0 }}
                    </td>
                    <td class="position-sticky px-8 py-px-12">
                      {{ area.processedSalaryLines || 0 }}
                    </td>
                    <td class="position-sticky px-8 py-px-12">
                      {{ area.pendingSalaryLines || 0 }}
                    </td>
                  </tr>
                </ng-template>

                <!-- Empty State for Daily Jobs -->
                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="7" class="bg-white fs-18 p-0 fw-medium text-center py-4">
                      There are no jobs for this date yet.
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  }
  @else {
    <div class="card border-0 h-100 shadow-md" [ngClass]="'vh-140'">
      <div class="empty-state">
        <div class="illustration bg-white">
          <svg class="height-12 width-12">
            <use xlink:href="#empty-state"></use>
          </svg>
        </div>
        <p class="bg-white fs-18 p-0 fw-medium color-gray-700 text-uppercase">
          {{ 'No data found' }}
        </p>
      </div>
    </div>
  }

  <!-- PrimeNG Paginator -->
  <p-paginator
    (onPageChange)="onPageChange($event)"
    [first]="first"
    [rows]="pageSize"
    [totalRecords]="totalRecords"
    [rowsPerPageOptions]="rowsPerPageOptions"
    [showCurrentPageReport]="true"
    [showJumpToPageDropdown]="false"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} jobs"
    styleClass="position-relative paginator-current-start"
  ></p-paginator>
</div>