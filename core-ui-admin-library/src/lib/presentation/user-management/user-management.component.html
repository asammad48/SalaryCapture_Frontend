<nav aria-label="breadcrumb" class="d-flex align-items-center justify-content-between mt-3 height-2" [ngClass]="isFilterApplied?'mb-2':'mb-3'">
    <p-breadcrumb class="max-w-full fw-medium" [model]="items" [home]="home"></p-breadcrumb>

    <!-- <div>
        <button type="button" class="btn btn-primary btn-sm me-2" (click)="syncUser()"> Sync Users</button>
         <button type="button" class="btn btn-primary btn-sm" (click)="NewUserModal()"> New User</button>
    </div> -->
</nav>

<div class="d-flex align-items-center gap-2 mb-2" *ngIf="isFilterApplied">
  <label class="fs-14 fw-semibold color-gray-800">Applied Filters:</label>

  <!-- Loop through all applied filters -->
  <ng-container *ngFor="let filter of appliedFilters">
    <div
      class="badge py-px-6 color-gray-800 bg-gray-100 d-inline-flex align-items-center justify-content-between gap-10 fs-12">
      <div class="fw-normal lh-1-3 d-flex gap-1" [title]="filter.label">
        <span class="text-capitalize">{{ filter.label }}:</span>
        <span class="d-inline-block max-w-5 text-truncate" [title]="filter.value">
          {{ filter.value }}
        </span>
      </div>
      <span class="close" (click)="removeFilter(filter.key)" id="remove-{{filter.label}}-filter-btn">
        <i class="fa-regular fa-circle-xmark fs-13 hover-gray-600 color-gray-700"></i>
      </span>
    </div>
  </ng-container>
</div>


<div class="card d-flex flex-column shadow-md h-64 border-0" [formGroup]="userFilters">
    <progress-loading
        loaderKey="UserMgt_ViewUsers"></progress-loading>
    <p-table [value]="userManagement" appendTo="body" [paginator]="true" [rows]="20" showGridlines
        [showCurrentPageReport]="true" currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        [rowsPerPageOptions]="[20, 50, 100, 500, 5000]" [styleClass]="isFilterApplied ? 'thead-sticky datawrapper-vh-220':'thead-sticky datawrapper-vh-190'"
        tableStyleClass="table table-p-3 user-management-table" [scrollable]="true" [paginatorStyleClass]="'position-relative paginator-current-start'">

        <ng-template #header>
            <tr>
                <!-- <th class="text-center">
                    <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                </th> -->
                <th class="position-relative">Name
                    <p-popover #nameFilter styleClass="popover-content-p-0 popover-arrow-none mt-0 min-w-16" id="user-name-filter-popover">
                        <div class="p-10">
                            <div class="input-group-wrapper end">
                                <input type="text" class="form-control focus-none border-gray-400"
                                    placeholder="Search..." formControlName="name" id="user-name-filter-input">
                                <div class="input-group-media icon">
                                    <svg aria-label="dropdown">
                                        <use xlink:href="#search"></use>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-center justify-content-end p-10">
                            <div class="btn-group">
                                <button class="btn btn-link btn-sm fw-normal py-1" (click)="resetFilter('name')" id="user-filter-reset-btn">
                                    Reset
                                </button>
                                <button class="btn btn-primary btn-sm fw-normal py-1 rounded-5"
                                    (click)="applyFilters('name')" id="user-filter-apply-btn">
                                    Apply
                                </button>
                            </div>
                        </div>
                    </p-popover>
                    <div (click)="nameFilter.toggle($event)"
                        class="color-gray-600 d-inline-block position-absolute top-2 end-4 p-1" id="user-filter-toggle-btn">
                        <i class="fa-filter fa-solid fs-12"></i>
                    </div>
                </th>
                <th class="position-relative">Username
                    <p-popover #userFilter styleClass="popover-content-p-0 popover-arrow-none mt-0 min-w-16" id="username-filter-popover">
                        <div class="p-10">
                            <div class="input-group-wrapper end">
                                <input type="text" class="form-control focus-none border-gray-400"
                                    placeholder="Search..." formControlName="userName" id="username-filter-input">
                                <div class="input-group-media icon">
                                    <svg aria-label="dropdown">
                                        <use xlink:href="#search"></use>
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex align-items-center justify-content-end p-10">
                            <div class="btn-group">
                                <button class="btn btn-link btn-sm fw-normal py-1"
                                    (click)="resetFilter('userName')" id="username-filter-reset-btn">
                                    Reset
                                </button>
                                <button class="btn btn-primary btn-sm fw-normal py-1 rounded-5"
                                    (click)="applyFilters('userName')" id="username-filter-apply-btn">
                                    Apply
                                </button>
                            </div>
                        </div>
                    </p-popover>
                    <div (click)="userFilter.toggle($event)"
                        class="color-gray-600 d-inline-block position-absolute top-2 end-4 p-1" id="username-filter-toggle-btn">
                        <i class="fa-filter fa-solid fs-12"></i>
                    </div>

                </th>
                <th class="position-relative">Status
                    <p-popover #statusFilter styleClass="popover-content-p-0 popover-arrow-none mt-0 min-w-14" id="user-status-filter-popover">
                        <div class="p-10">

                            <ul class="list-unstyled mb-0 max-h-10 min-h-6 overflow-y-auto"
                                formGroupName="statusFilter">

                                <!-- All checkbox -->
                                <li class="py-2">
                                    <div class="d-flex align-items-center gap-6">
                                        <p-checkbox [binary]="true" inputId="optAll" class="d-flex"
                                            formControlName="all" [indeterminate]="allStatusIndeterminate"
                                            labelStyleClass="fs-14" id="user-status-filter-all-checkbox">
                                        </p-checkbox>
                                        <label for="optAll" class="fs-14">All</label>
                                    </div>
                                </li>

                                <!-- Dynamic checkboxes -->
                                @for (opt of statusOptions; track opt.key) {
                                <li class="py-2">
                                    <div class="d-flex align-items-center gap-6">
                                        <p-checkbox [binary]="true" class="d-flex" [inputId]="opt.key"
                                            formControlName="{{ opt.key }}" labelStyleClass="fs-14" id="user-status-filter-{{opt.key}}-checkbox">
                                        </p-checkbox>
                                        <label [for]="opt.key" class="fs-14">{{ opt.label }}</label>
                                    </div>
                                </li>
                                }

                            </ul>
                        </div>

                        <div class="d-flex align-items-center justify-content-end p-10">
                            <div class="btn-group">
                                <button class="btn btn-link btn-sm fw-normal py-1"
                                    (click)="resetStatusFilter('statusFilter')" id="user-status-filter-reset-btn">
                                    Reset
                                </button>
                                <button class="btn btn-primary btn-sm fw-normal py-1 rounded-5"
                                    (click)="applyFilters('status')" id="user-status-filter-apply-btn">
                                    Apply
                                </button>
                            </div>
                        </div>
                    </p-popover>
                    <div (click)="statusFilter.toggle($event)"
                        class="color-gray-600 d-inline-block position-absolute top-2 end-4 p-1" id="user-status-filter-toggle-btn">
                        <i class="fa-filter fa-solid fs-12"></i>
                    </div>
                </th>
                <th class="position-relative">Role
                    <p-popover #roleFilter styleClass="popover-content-p-0 popover-arrow-none mt-0 min-w-16" id="user-role-filter-popover">
                        <div class="p-10">
                            <ul class="list-unstyled mb-0 max-h-10 min-h-6 overflow-y-auto"
                                formGroupName="roleFilter">

                                <!-- All checkbox -->
                                <li class="py-2">
                                    <div class="d-flex align-items-center gap-6">
                                        <p-checkbox [binary]="true" inputId="roleAll" class="d-flex"
                                            formControlName="all" [indeterminate]="allRolesIndeterminate"
                                            labelStyleClass="fs-14">
                                        </p-checkbox>
                                        <label for="roleAll" class="fs-14">All</label>
                                    </div>
                                </li>

                                <!-- Dynamic role checkboxes -->
                                @for (role of roles; track role.roleName) {
                                <li class="py-2">
                                    <div class="d-flex align-items-center gap-6">
                                        <p-checkbox [binary]="true" class="d-flex" [inputId]="role.roleName"
                                            formControlName="{{ role.roleName }}" labelStyleClass="fs-14">
                                        </p-checkbox>
                                        <label [for]="role.roleName" class="fs-14">{{ role.displayName }}</label>
                                    </div>
                                </li>
                                }
                            </ul>
                        </div>

                        <div class="d-flex align-items-center justify-content-end p-10">
                            <div class="btn-group">
                                <button class="btn btn-link btn-sm fw-normal py-1" (click)="resetRoleFilter('roleFilter')" id="user-role-filter-reset-btn">Reset
                                </button>
                                <button class="btn btn-primary btn-sm fw-normal py-1 rounded-5"
                                    (click)="applyFilters('roleFilter')">Apply
                                </button>
                            </div>
                        </div>
                    </p-popover>
                    <div (click)="roleFilter.toggle($event)"
                        class="color-gray-600 d-inline-block position-absolute top-2 end-4 p-1" id="user-role-filter-toggle-btn">
                        <i class="fa-filter fa-solid fs-12"></i>
                    </div>
                </th>
                <th>Regions</th>
                <th>Areas</th>

                <th class="position-relative">Created At
                    <p-popover #dateFilter styleClass="popover-content-p-0 popover-arrow-none mt-0 min-w-16" id="user-createdat-filter-popover">
                        <div class="p-10">
                            <div class="input-group-wrapper end">
                                <p-datepicker styleClass="w-100"
                                    inputStyleClass="shadow-none border-gray-400 pe-auto cursor-pointer bg-white w-100"
                                    formControlName="createdAt" [iconDisplay]="'input'" [showIcon]="true"
                                    inputId="icondisplay" placeholder="dd-mm-yyyy" dateFormat="dd-mm-yy" id="user-createdat-filter-input"/>
                            </div>
                        </div>

                        <div class="d-flex align-items-center justify-content-end p-10">
                            <div class="btn-group">
                                <button class="btn btn-link btn-sm fw-normal py-1"
                                    (click)="resetFilter('createdAt')" id="user-createdat-filter-reset-btn">
                                    Reset
                                </button>
                                <button class="btn btn-primary btn-sm fw-normal py-1 rounded-5"
                                    (click)="applyFilters('createdAt')" id="user-createdat-filter-apply-btn">
                                    Apply
                                </button>
                            </div>
                        </div>
                    </p-popover>
                    <div (click)="dateFilter.toggle($event)"
                        class="color-gray-600 d-inline-block position-absolute top-2 end-4 p-1" id="user-createdat-filter-toggle-btn">
                        <i class="fa-filter fa-solid fs-12"></i>
                    </div>
                </th>
                <th alignFrozen="right" pFrozenColumn></th>
            </tr>
        </ng-template>

        <ng-template #body let-user let-i="rowIndex">
            <tr>
                <!-- <td class="text-center">
                    <p-tableCheckbox [value]="user"></p-tableCheckbox>
                </td> -->
                <td> {{user.name}}</td>
                <td>
                    {{user.userName}}
                </td>
                <td>
                    <ng-container *ngIf="user.status === 'Block'">
                        <p-tag styleClass="badge bg-danger-100 color-danger-400 fs-11 py-px-6 fw-medium min-w-5"
                            value="Blocked"></p-tag>
                    </ng-container>
                    <ng-container *ngIf="user.status === 'Active'">
                        <p-tag styleClass="badge bg-success-100 color-success-400 fs-11 py-px-6 fw-medium min-w-5"
                            value="Active"></p-tag>
                    </ng-container>
                </td>
                <td>{{user.role === null ? '-' : user.role}}</td>
                <td><a (click)="user.regions.length > 0 ? regionsDialog(user) : ''" [ngClass]="{'text-primary cursor-pointer hover-text-underline' : user.regions.length > 0}">{{user.regionsCount}}</a></td>
                <td><a (click)="user.areasCount > 0 ? areasDialog(user) : ''" [ngClass]="{'text-primary cursor-pointer hover-text-underline' : user.areasCount > 0}">{{user.areasCount}}</a></td>
                <!-- <td>{{user.createdBy === null ? '-' : user.createdBy}}</td> -->
                <td>{{ formatDate(user.createdAt)}}</td>
                <td class="menu sticky-column-end width-1">
                    <p-menu #menuRef [model]="getUserMenus(user)" [popup]="true" appendTo="body" class="user-menus">
                        <ng-template let-item pTemplate="item">
                            <a class="p-menuitem-link p-ripple d-block lh-1-4 {{item.styleClass}}" id="user-action-{{item.label}}-btn">
                                <span class="p-menuitem-text fs-14">{{ item.label }}</span>
                            </a>
                        </ng-template>
                    </p-menu>

                    <div (click)="openMenu($event, menuRef)" class="cursor-pointer" id="user-action-menu-{{user.userName}}-btn">
                        <i class="fa fa-ellipsis-v m-0 fs-18"></i>
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template #emptymessage>
            <div class="empty-state grid">
                <div class="illustration bg-white">
                    <svg class="height-12 width-12">
                        <use xlink:href="#empty-state"></use>
                    </svg>
                </div>
                <p class="bg-white fs-18 p-0 fw-medium color-gray-700">No Record Found</p>
            </div>
        </ng-template>
    </p-table>
</div>
