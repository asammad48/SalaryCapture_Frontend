<div class="d-flex align-items-center gap-2 my-2" *ngIf="isFilterApplied">
  <label class="fs-14 fw-semibold color-gray-800">Applied Filters:</label>

  @for (filter of appliedFilters; track filter.key) {
    <div
      class="badge py-px-6 color-gray-800 bg-gray-100 d-inline-flex align-items-center justify-content-between gap-10 fs-12">
      <div class="fw-normal lh-1-3 d-flex gap-1">
        <span class="text-capitalize">{{ filter.label }}:</span>
        <span class="d-inline-block max-w-5 text-truncate" [title]="filter.value">
          {{ filter.value }}
        </span>
      </div>
      <span class="close cursor-pointer" (click)="removeFilter(filter.key)">
        <i class="fa-regular fa-circle-xmark fs-13 hover-gray-600 color-gray-700"></i>
      </span>
    </div>
  }
</div>

<div class="card d-flex flex-column shadow-md h-64 border-0 position-relative" [ngClass]="isFilterApplied?'mt-2':'mt-3'">
  <dp-progress-loading loaderKey="BasePlan_List"></dp-progress-loading>

  <p-table
    [value]="basePlans"
    appendTo="body"
    [paginator]="true"
    [rows]="pageSize"
    [first]="first"
    [totalRecords]="totalRecords"
    (onLazyLoad)="onPageChange($event)"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    [rowsPerPageOptions]="[10, 20, 50, 100]"
    [styleClass]="isFilterApplied ? 'thead-sticky datawrapper-vh-220':'thead-sticky datawrapper-vh-190'"
    tableStyleClass="table base-plan-table" [scrollable]="true"
    [paginatorStyleClass]="'position-relative paginator-current-start'">

    <ng-template #header>
      <tr>
        <!-- <th class="width-px-40 text-center">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th> -->
        <th class="position-relative">Name
          <p-popover #nameFilter styleClass="popover-content-p-0 popover-arrow-none mt-0 min-w-16"
            id="user-name-filter-popover">
            <div class="p-10">
              <div class="input-group-wrapper end">
                <input type="text" class="form-control focus-none border-gray-400" placeholder="Search..."
                  id="user-name-filter-input" [(ngModel)]="nameFilterValue">
                <div class="input-group-media icon">
                  <svg aria-label="dropdown">
                    <use xlink:href="#search"></use>
                  </svg>
                </div>
              </div>
            </div>

            <div class="d-flex align-items-center justify-content-end p-10">
              <div class="btn-group">
                <button class="btn btn-link btn-sm fw-normal py-1" (click)="resetFilter()"
                  id="user-filter-reset-btn">
                  Reset
                </button>
                <button class="btn btn-primary btn-sm fw-normal py-1 rounded-5" (click)="applyFilters()"
                  id="user-filter-apply-btn">
                  Apply
                </button>
              </div>
            </div>
          </p-popover>
          <div (click)="nameFilter.toggle($event)"
            class="color-gray-600 d-inline-block position-absolute top-2 end-4 p-1" id="user-filter-toggle-btn">
            <i class="fa-filter fa-solid fs-12"></i>
          </div>
        </th>
        <th class="position-relative">Status
          <p-popover #statusFilter styleClass="popover-content-p-0 popover-arrow-none mt-0 min-w-14"
            id="user-status-filter-popover">
            <div class="p-10">
              <ul class="list-unstyled mb-0 max-h-10 min-h-6 overflow-y-auto">
                <li class="py-2">
                  <div class="d-flex align-items-center gap-6">
                    <p-checkbox [binary]="true" inputId="optAll" class="d-flex" [indeterminate]="allStatusIndeterminate"
                      [formControl]="$any(statusFilterForm.get('all'))"
                      labelStyleClass="fs-14" id="user-status-filter-all-checkbox">
                    </p-checkbox>
                    <label for="optAll" class="fs-14">All</label>
                  </div>
                </li>

                @for (opt of statusOptions; track opt.key) {
                <li class="py-2">
                  <div class="d-flex align-items-center gap-6">
                    <p-checkbox [binary]="true" class="d-flex" [inputId]="opt.key.toString()"
                      [formControl]="$any(statusFilterForm.get(opt.key))"
                      labelStyleClass="fs-14"
                      id="user-status-filter-{{opt.key}}-checkbox">
                    </p-checkbox>
                    <label [for]="opt.key.toString()" class="fs-14">{{ opt.label }}</label>
                  </div>
                </li>
                }

              </ul>
            </div>

            <div class="d-flex align-items-center justify-content-end p-10">
              <div class="btn-group">
                <button class="btn btn-link btn-sm fw-normal py-1" (click)="resetFilter()"
                  id="user-status-filter-reset-btn">
                  Reset
                </button>
                <button class="btn btn-primary btn-sm fw-normal py-1 rounded-5" (click)="applyFilters()"
                  id="user-status-filter-apply-btn">
                  Apply
                </button>
              </div>
            </div>
          </p-popover>
          <div (click)="statusFilter.toggle($event)"
            class="color-gray-600 d-inline-block position-absolute top-2 end-4 p-1" id="user-status-filter-toggle-btn">
            <i class="fa-filter fa-solid fs-12"></i>
          </div>
        </th>
        <th>Start Date
        </th>
        <th>End Date
        </th>
        <th>Created By</th>
        <th class="position-relative">Creation Date
          <p-popover #dateFilter styleClass="popover-content-p-0 popover-arrow-none mt-0 min-w-16"
            id="user-createdat-filter-popover">
            <div class="p-10">
              <div class="input-group-wrapper end">
                <p-datepicker styleClass="w-100"
                  inputStyleClass="shadow-none border-gray-400 pe-auto cursor-pointer bg-white w-100"
                  [iconDisplay]="'input'" [showIcon]="true" inputId="icondisplay" placeholder="dd-mm-yyyy"
                  dateFormat="dd-mm-yy" [(ngModel)]="createdOnFilterValue" id="user-createdat-filter-input" />
              </div>
            </div>

            <div class="d-flex align-items-center justify-content-end p-10">
              <div class="btn-group">
                <button class="btn btn-link btn-sm fw-normal py-1" (click)="resetFilter()"
                  id="user-createdat-filter-reset-btn">
                  Reset
                </button>
                <button class="btn btn-primary btn-sm fw-normal py-1 rounded-5" (click)="applyFilters()"
                  id="user-createdat-filter-apply-btn">
                  Apply
                </button>
              </div>
            </div>
          </p-popover>
          <div (click)="dateFilter.toggle($event)"
            class="color-gray-600 d-inline-block position-absolute top-2 end-4 p-1"
            id="user-createdat-filter-toggle-btn">
            <i class="fa-filter fa-solid fs-12"></i>
          </div>
        </th>
        <th alignFrozen="right" pFrozenColumn></th>
      </tr>
    </ng-template>

    <ng-template #body let-plan let-i="rowIndex">
      <tr>
        <!-- <td class="width-px-40 text-center">
          <p-tableCheckbox [value]="plan"></p-tableCheckbox>
        </td> -->
        <td>
          <a class="text-primary cursor-pointer" [routerLink]="['/daily-planning/base-plan/base-plan-job-packages', plan.id]">
            {{plan.name}}
          </a>
        </td>
        <td>
          <span
            [ngClass]="{
              'text-warning': plan.statusId === BasePlanStatus.Uploaded,
              'text-info': plan.statusId === BasePlanStatus.Processing,
              'text-danger': plan.statusId === BasePlanStatus.Error,
              'text-secondary': plan.statusId === BasePlanStatus.Scheduled,
              'text-primary': plan.statusId === BasePlanStatus.InProgress,
              'text-success': plan.statusId === BasePlanStatus.Completed
            }">
            <ng-container *ngIf="plan.statusId === BasePlanStatus.Uploaded">Uploaded</ng-container>
            <ng-container *ngIf="plan.statusId === BasePlanStatus.Processing">Processing</ng-container>
            <ng-container *ngIf="plan.statusId === BasePlanStatus.Error">Error</ng-container>
            <ng-container *ngIf="plan.statusId === BasePlanStatus.Scheduled">Scheduled</ng-container>
            <ng-container *ngIf="plan.statusId === BasePlanStatus.InProgress">In Progress</ng-container>
            <ng-container *ngIf="plan.statusId === BasePlanStatus.Completed">Completed</ng-container>
          </span>
        </td>
        <td>
          {{getFormattedDate(plan.startDate)}}
        </td>
        <td>
          {{getFormattedDate(plan.endDate)}}
        </td>
        <td>
          {{plan.createdBy}}
        </td>
        <td>
          {{getFormattedDate(plan.createdOn)}}
        </td>
        <td class="menu sticky-column-end width-1">
          <p-menu #menuRef [model]="getPlanMenus(plan)" [popup]="true" appendTo="body" class="plan-menus">
            <ng-template let-item pTemplate="item">
              <a class="p-menuitem-link p-ripple d-block lh-1-4 {{item.styleClass}}"
                id="plan-action-{{item.label}}-btn">
                <span class="p-menuitem-text fs-14">{{ item.label }}</span>
              </a>
            </ng-template>
          </p-menu>

          <div (click)="openMenu($event, menuRef)" class="cursor-pointer" id="plan-action-menu-{{plan.name}}-btn">
            <i class="fa fa-ellipsis-v m-0 fs-18"></i>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template #emptymessage>
      <div class="empty-state grid">
        <div class="illustration bg-white">
          <svg class="height-12 width-12">
            <use xlink:href="#empty-state"></use>
          </svg>
        </div>
        <p class="bg-white fs-18 p-0 fw-medium color-gray-700">No Record Found</p>
      </div>
    </ng-template>
  </p-table>
</div>
